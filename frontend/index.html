<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cogni Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .chat-container {
            width: 100%;
            max-width: 450px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .chat-header h2 {
            margin-bottom: 5px;
            font-size: 1.4em;
        }
        .chat-header p {
            opacity: 0.9;
            font-size: 0.9em;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }
        .message.bot {
            justify-content: flex-start;
        }
        .message.user {
            justify-content: flex-end;
        }
        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.9em;
            line-height: 1.4;
        }
        .message.bot .message-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .message.user .message-bubble {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 8px;
        }
        .question-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
        }
        .multi-select-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .option-button, .multi-select-button {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            text-align: left;
            user-select: none;
        }
        .multi-select-button {
            flex: 1 0 calc(50% - 8px);
        }
        .option-button:hover, .multi-select-button:hover {
            background: #e7e7e7;
            transform: translateY(-1px);
        }
        .option-button.selected, .multi-select-button.selected {
            background: #667eea !important;
            color: white !important;
            border-color: #667eea !important;
        }
        .next-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 12px;
            width: 100%;
            transition: background 0.3s ease;
        }
        .next-button:hover:not(:disabled) {
            background: #5a67d8;
        }
        .next-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            border-bottom-left-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 80%;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        .recommendation-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            margin-top: 12px;
        }
        .recommendation-card h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .recommendation-card p {
            margin-bottom: 8px;
            opacity: 0.9;
        }
        .recommendation-card strong {
            color: #fff;
        }
        .recommendation-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .recommendation-card li {
            margin-bottom: 5px;
        }
        .restart-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 12px;
            transition: all 0.3s ease;
        }
        .restart-button:hover {
            background: rgba(255,255,255,0.3);
        }
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        .status-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        .status-indicator.processing {
            background: rgba(255, 165, 0, 0.8);
        }
        .status-indicator.ready {
            background: rgba(0, 128, 0, 0.8);
        }
    </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <h2>Cogni Professional Therapeutic Copilot</h2>
      <p>Delivering personalized package recommendations for mental health providers</p>
    </div>

    <div class="chat-messages" id="chatMessages">
      <!-- Messages will be added here -->
    </div>
  </div>

  <div class="debug-info" id="debugInfo">
    Step: <span id="currentStepDisplay">0</span> / 5 | 
    Responses: <span id="responseCount">0</span>
  </div>

  <div class="status-indicator ready" id="statusIndicator">
    Ready
  </div>

  <script>
    class CogniChatbot {
      constructor() {
        this.currentStep = 0;
        this.userResponses = {};
        this.messagesContainer = document.getElementById('chatMessages');
        this.isProcessing = false;
        this.selectedOptions = new Set();
        this.currentNextButton = null;

        this.questions = [
          {
            id: 'org_type',
            text: 'What type of organization are you?',
            type: 'single',
            options: [
              'Insurance Provider / EAS',
              'Mental Health Practitioner â€“ Private Practice',
              'Mental Health or Healthcare Provider â€“ Public System',
              'Home Care or Specialized Residential Services',
              'Other'
            ]
          },
          {
            id: 'team_size',
            text: 'How many professionals in your organization would need access to the platform?',
            type: 'single',
            options: [
              '1 (Solo practice)',
              '2â€“5 providers',
              '6â€“15 providers',
              '16â€“50 providers',
              '51+ providers',
              'Not sure yet'
            ]
          },
          {
            id: 'team_roles',
            text: 'What roles are included in your care team? (Select all that apply)',
            type: 'multi',
            options: [
              'Therapists / Counselors',
              'Doctors (e.g. General Practitioners, Psychiatrists, Specialists)',
              'Case Managers',
              'Nurses / Health Professionals',
              'Coaches / Peer Support Workers',
              'Administrative or Intake Staff'
            ]
          },
          {
            id: 'client_volume',
            text: 'How many clients or service users do you support monthly?',
            type: 'single',
            options: [
              'Less than 100',
              '100â€“500',
              '501â€“1,000',
              'Over 1,000'
            ]
          },
          {
            id: 'services',
            text: 'What services do you currently provide? (Select all that apply)',
            type: 'multi',
            options: [
              'Mental health therapy or counseling',
              'Pre- or post-surgical support',
              'Home-based care or wellness monitoring',
              'Group therapy or workshops',
              'Case management and referrals'
            ]
          }
        ];

        // Package definitions removed - now using API
        this.init();
      }

      updateStatus(status) {
        const indicator = document.getElementById('statusIndicator');
        indicator.textContent = status;
        indicator.className = `status-indicator ${status === 'Processing...' ? 'processing' : 'ready'}`;
      }

      init() {
        this.updateDebugInfo();
        this.updateStatus('Ready');
        
        this.addBotMessage(`<strong>Welcome to Cogni Professional Therapeutic Copilot!</strong> I'm here to provide personalized recommendations tailored to your needs. Whether you're exploring solutions or looking for guidance.<br><br>Your privacy is a priority, and all interactions remain confidential while adhering to relevant regulations. Feel free to ask questions, and let's find the best path forward together!`);
        
        setTimeout(() => {
          this.askQuestion();
        }, 1500);
      }

      updateDebugInfo() {
        document.getElementById('currentStepDisplay').textContent = this.currentStep;
        document.getElementById('responseCount').textContent = Object.keys(this.userResponses).length;
      }

      addBotMessage(text, isRecommendation = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot';

        if (isRecommendation) {
          messageDiv.innerHTML = `
            <div class="message-bubble">
              <div class="recommendation-card">
                ${text}
                <button class="restart-button" onclick="window.chatbot.restart()">Start Over</button>
              </div>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `<div class="message-bubble">${text}</div>`;
        }

        this.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
      }

      askQuestion() {
        if (this.isProcessing) return;
        
        if (this.currentStep >= this.questions.length) {
          this.getRecommendation();
          return;
        }

        const question = this.questions[this.currentStep];
        this.selectedOptions.clear();
        this.currentNextButton = null;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot';
        
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'message-bubble';
        
        const questionText = document.createElement('p');
        questionText.innerHTML = `<strong>${question.text}</strong>`;
        bubbleDiv.appendChild(questionText);
        
        const optionsDiv = document.createElement('div');
        optionsDiv.className = question.type === 'multi' ? 'multi-select-options' : 'question-options';
        
        question.options.forEach((option, index) => {
          const button = document.createElement('button');
          button.className = question.type === 'multi' ? 'multi-select-button' : 'option-button';
          button.textContent = option;
          button.dataset.option = option;
          button.dataset.index = index;
          
          if (question.type === 'multi') {
            button.addEventListener('click', () => this.handleMultiSelectClick(button, option));
          } else {
            button.addEventListener('click', () => this.handleSingleSelectClick(option));
          }
          
          optionsDiv.appendChild(button);
        });
        
        bubbleDiv.appendChild(optionsDiv);
        
        if (question.type === 'multi') {
          const nextBtn = document.createElement('button');
          nextBtn.className = 'next-button';
          nextBtn.textContent = 'Next';
          nextBtn.disabled = true;
          nextBtn.addEventListener('click', () => this.handleMultiSelectNext());
          
          this.currentNextButton = nextBtn;
          bubbleDiv.appendChild(nextBtn);
        }
        
        messageDiv.appendChild(bubbleDiv);
        this.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
        this.updateDebugInfo();
        this.updateStatus('Ready');
      }

      handleMultiSelectClick(button, option) {
        if (this.isProcessing) return;
        
        if (this.selectedOptions.has(option)) {
          this.selectedOptions.delete(option);
          button.classList.remove('selected');
        } else {
          this.selectedOptions.add(option);
          button.classList.add('selected');
        }
        
        this.updateNextButtonState();
      }

      updateNextButtonState() {
        if (this.currentNextButton) {
          this.currentNextButton.disabled = this.selectedOptions.size === 0;
        }
      }

      handleSingleSelectClick(option) {
        if (this.isProcessing) return;
        this.processAnswer(option);
      }

      handleMultiSelectNext() {
        if (this.isProcessing || this.selectedOptions.size === 0) return;
        
        const selectedArray = Array.from(this.selectedOptions);
        this.processAnswer(selectedArray);
      }

      processAnswer(answer) {
        if (this.isProcessing) return;
        
        this.isProcessing = true;
        this.updateStatus('Processing...');
        
        const question = this.questions[this.currentStep];
        this.userResponses[question.id] = answer;
        
        const displayText = Array.isArray(answer) ? answer.join(', ') : answer;
        this.addUserMessage(displayText);
        
        setTimeout(() => {
          this.currentStep++;
          this.isProcessing = false;
          this.askQuestion();
        }, 800);
      }

      addUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user';
        messageDiv.innerHTML = `<div class="message-bubble">${text}</div>`;
        this.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
        this.updateDebugInfo();
      }

      scrollToBottom() {
        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
      }

      // Call the FastAPI backend for recommendations
      async generateRecommendation() {
        const responses = this.userResponses;
        
        // Prepare data for API call matching your FastAPI model
        const requestData = {
          org_type: responses.org_type || '',
          team_size: responses.team_size || '',
          team_roles: responses.team_roles || [],
          client_volume: responses.client_volume || '',
          services: responses.services || [],
          specializations: [] // Add if you collect specializations in the future
        };

        try {
          // Make API call to your FastAPI backend
          const response = await fetch('/getRecommendation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
          });

          if (!response.ok) {
            throw new Error(`API call failed: ${response.status} ${response.statusText}`);
          }

          const recommendation = await response.json();
          
          // Return the recommendation in the expected format
          return {
            recommended_package: recommendation.recommended_package,
            recommended_seats: recommendation.recommended_seats,
            estimated_pricing: recommendation.estimated_pricing,
            key_features: recommendation.key_features,
            next_steps: recommendation.next_steps,
            sales_message: recommendation.sales_message
          };

        } catch (error) {
          console.error('Error calling recommendation API:', error);
          
          // Fallback recommendation if API fails
          return {
            recommended_package: 'Community Access',
            recommended_seats: 10,
            estimated_pricing: '$490',
            key_features: ['Multilingual AI tools', 'Scalable group support', 'Onboarding support'],
            next_steps: 'https://cogni-recommendation-chuiv5x8slzxktq3mzbb5p.streamlit.app/?tier=Community%20Access&seats=10&utm_source=chatbot',
            sales_message: 'Error connecting to recommendation service. Please try again or contact support.'
          };
        }
      }

      async getRecommendation() {
        this.addBotMessage(`Thank you for completing the assessment! Based on your responses, I'm generating personalized recommendations for your organization.`);
        
        this.showTypingIndicator();
        
        // Call the API to get recommendation
        try {
          const recommendation = await this.generateRecommendation();
          
          setTimeout(() => {
            this.hideTypingIndicator();
            this.showRecommendation(recommendation);
          }, 1000);
        } catch (error) {
          console.error('Error getting recommendation:', error);
          setTimeout(() => {
            this.hideTypingIndicator();
            this.addBotMessage('Sorry, there was an error generating your recommendation. Please try again or contact support.');
          }, 1000);
        }
      }

      showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `
          <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        `;
        this.messagesContainer.appendChild(typingDiv);
        this.scrollToBottom();
      }

      hideTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      showRecommendation(recommendation) {
        const recommendationText = `
          <h3>Recommended Package: ${recommendation.recommended_package}</h3>
          <p>Based on your responses, we recommend the <em>${recommendation.recommended_package}</em> package with ${recommendation.recommended_seats} seats.</p>
          <p><strong>Estimated Price:</strong> ${recommendation.estimated_pricing}</p>
          <p><strong>Key Features:</strong></p>
          <ul>
            ${recommendation.key_features.map(feature => `<li>${feature}</li>`).join('')}
          </ul>
          <p><a href="${recommendation.next_steps}" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold;">ðŸ“Š Click here to find out more</a></p>
        `;
        
        this.addBotMessage(recommendationText, true);
        
        // Log the recommendation details for debugging
        console.log('API recommendation:', recommendation);
        console.log('User responses:', this.userResponses);
      }

      restart() {
        this.currentStep = 0;
        this.userResponses = {};
        this.isProcessing = false;
        this.selectedOptions.clear();
        this.currentNextButton = null;
        this.messagesContainer.innerHTML = '';
        this.updateDebugInfo();
        this.updateStatus('Ready');
        this.init();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.chatbot = new CogniChatbot();
      console.log('Chatbot initialized');
    });
  </script>
</body>
</html>